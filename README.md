# GreenMapper

### Сервис сбора и отображения городских проблем на карте с системой заявок, типами проблем и статусами их решения, а также аутентификацией и ролями пользователей

> Фронтенд: <br/>
  React + Vite + OpenLayers <br/>
>
> Бэкенд: <br/>
  Bun + Elysia + PostgreSQL + Drizzle ORM <br/>
>
> Аутентификация: <br/>
  Better Auth

## Участники
| ФИО | Группа |
|-----|--------|
| Терещенков Николай Юрьевич | 5130904/30101 |
| Пузанов Егор Алексеевич	| 5130904/30101 | 
| Полубояринов Илья Вадимович	| 5130904/30101 |
| Яковлев Глеб Павлович	| 5130904/30101 |


## Определение проблемы
Горожанам сложно сообщать о локальных проблемах (разбитые дороги, разбросанный мусор, неработающие фонари) и оперативно отслеживать ход их решения. Инструменты городских служб либо недоступны, либо неудобны. Отсутствует единая точка для подачи заявки на карте с понятной категоризацией и прозрачным статусом выполнения.

## Выработка требований

### Пользовательские истории
1. Как пользователь, я хочу авторизоваться и создавать заявку на карте с указанием адреса, координат и типа проблемы, чтобы фиксировать проблему в системе.
2. Как пользователь, я хочу видеть все заявки на карте с кратким описанием, именем автора, типом и статусом, чтобы понимать обстановку в районе.
3. Как пользователь, я хочу видеть список доступных типов заявок и фильтровать по ним, чтобы находить подходящие проблемы.
4. Как администратор, я хочу менять статус заявки (например, «в обработке», «в работе», «выполнено») и при необходимости удалять некорректные заявки, чтобы поддерживать актуальность данных.
5. Как пользователь, я хочу видеть свой профиль и количество баллов за активность, чтобы понимать вклад в сообщество.

## Разработĸа архитеĸтуры и детальное проеĸтирование

### Оценка масштаба 
10 000 активных пользователей/сутки; период хранения данных: > 5 лет.

#### Характер нагрузки
- Соотношение R/W: запись превышает чтение, т.к. ~95% пользователей - горожане, основной сценарий - это подача заявок. <br/>
Будем считать: **60% запись / 40% чтение** (С учётом подгрузки всех заявок при заходе в приложении и кешировании данного процесса).
- Трафик 
  - Запросы в день (без фото, оценка): при 10 000 пользователей допустим  ~11 000-12 000 запросов/день.
  - RPS: `12 000 / (24×60×60) = 0,139 rps`
  - RPM:  `= 8,3 rpm`
  - Трафик (JSON, без фото):
    - Запросы на запись (тела/ответы ~0,8-1,2 КБ): при ~6 900/день = 8-9 МБ/день;
    - Запросы на чтение (~30 КБ на ответ): ~4 600/день = 138 МБ/день;
    - Итого: ~ `147 МБ/день`
- Диски (метаданные без фото): одна запись заявки ~1-2 КБ. При при ~6 900 заявок/день = `8-9 МБ/день`. Хранение фото предусмотрено в БД.

После реализации подгрузки фото для заявки, трафик и использование диска увеличатся:
- При среднем размере фото 2 МБ и доле 30% заявок с фото: `6 900 * 0,3 * 2 МБ = 4,14 ГБ/день` дополнительного сетевого трафика (к JSON‑трафику выше).
Итого для трафика будет ~ `4,28 ГБ/день` 
- Хранение: +4,14 ГБ/день; за 5 лет (~1 825 дней) - около `7,6 ТБ` без учёта очистки/сжатия.

### Диаграммы C4 Model
Контекст:

<img src="docs/контекст.jpg" alt="Схема C4. Контекст" width="80%">

Контейнеры:

<img src="docs/контейнеры.jpg" alt="Схема C4. Контейнеры" width="80%">

Компоненты:

<img src="docs/компоненты.jpg" alt="Схема C4. Компоненты" width="80%">

### Контракты API
Краткая спецификация приведена в разделе «API (детально)» ниже.

### Схема БД и нефункциональные требования
Основные таблицы: `user`, `issues`, `issue_types`, `issue_statuses`, дополнительные: `photos`, `comments`, `admin_actions`.

Отношения заданы через Drizzle `relations(...)`. Миграции - в `backend/drizzle/`.

ERD схема:

<img src="docs/db.png" alt="ERD схема" width="80%">



Нефункциональным требования:

### Производительность

- Нормализация таблиц (user, session, account) уменьшает дублирование и ускоряет запросы за счёт кэширования планов в Postgres.
- Целочисленные ключи для основных таблиц и текстовые для auth-таблиц минимизируют затраты на джоины, уменьшая размер индексов и повышая селективность.

### Целостность данных

- Метаданные в Postgres обеспечивают строгую транзакционную согласованность через внешние ключи (FK) и каскадное удаление, исключая «висячие» записи.
- FK на user.id в основных таблицах гарантируют целостность без дополнительных проверок.

### Безопасность

- Хранение данных аутентификации в Postgres упрощает аудит, отзыв токенов и ротацию сессий, соответствуя требованиям Better Auth.
- Postgres поддерживает RLS/ACL и аудит доступа, обеспечивая минимальные привилегии.

### Сопровождение

- Схема совместима с Drizzle и Better Auth, упрощая миграции и типобезопасные запросы. 
- Индексы и структура схемы облегчают диагностику (EXPLAIN) и обслуживание (VACUUM/REINDEX). 

Идентификаторы: `issues.issueId` (serial), пользователи - внешнеуправляемые `user.id` (text, Better Auth). Для долгосрочного хранения >5 лет - миграции (Drizzle) и возможность шардирования при росте объёма.

### Схема масштабирования x10
- Горизонтальное масштабирование бэкенда за балансировщиком (stateless, сессии - cookie + Better Auth). 
- БД: увеличение размеров пула соединений, реплика для чтения, добавить секционирование, индексы по `statusId`, `typeId`, `(latitude, longitude)` при потребности в геопоиске (геоиндексы - план на расширение сервиса).
- Кэширование частых выборок `/reports/`


## Unit-тестирование
TODO

## Интеграционное тестирование
TODO

## Сборка и запуск
TODO


## API (детально)

Бэкенд: `http://localhost:3000`. CORS разрешает `http://localhost:5173`.

### Аутентификация (Better Auth)
Better Auth - `/auth` <br/>
Основные вызовы:

- `POST /auth/api/sign-up/email` - регистрация по email+паролю
- `POST /auth/api/sign-in/email` - вход по email+паролю
- `POST /auth/api/sign-out` - выход

TODO: добавить везде параметры запроса

Пример успешного ответа входа (200):
```json
{
  "redirect": false,
  "token": "string",
  "url": null,
  "user": {
    "id": "string",
    "email": "string",
    "name": "string | null",
    "image": "string | null",
    "emailVerified": true,
    "createdAt": "2025-01-01T00:00:00.000Z",
    "updatedAt": "2025-01-01T00:00:00.000Z"
  }
}
```


### Пользователь
- `GET /users/me` - профиль текущего пользователя (требуется авторизация). Возвращает записи из БД (`user`), например:
```json
{
  "id": "uuid",
  "name": "Иван",
  "email": "user@example.com",
  "emailVerified": true,
  "image": null,
  "createdAt": "2025-01-01T00:00:00.000Z",
  "updatedAt": "2025-01-01T00:00:00.000Z",
  "points": 3,
  "role": "user"
}
```

### Заявки (`/reports`)

- `GET /reports/` - список заявок с данными пользователя, типа и статуса.
```json
[
  {
    "issueId": 123,
    "shortDescription": "Свалка у подъезда",
    "detailedDescription": "Пакеты мусора лежат 3 дня",
    "address": "ул. Примерная, 1",
    "latitude": "59.93863",
    "longitude": "30.31413",
    "createdAt": "2025-01-01T12:00:00.000Z",
    "expectedResolutionDate": null,
    "statusName": "В обработке",
    "typeName": "Мусор",
    "userName": "Иван",
    "userPoints": 3,
    "statusId": 1
  }
]
```

- `GET /reports/:id` - одна заявка по ID. `404`, если не найдена.

- `GET /reports/issue-types` - список типов заявок.
```json
[
  { "typeId": 1, "name": "Мусор" },
  { "typeId": 2, "name": "Дороги" }
]
```

- `POST /reports/` - создать заявку (авторизация обязательна).
```json
{
  "latitude": "59.93863",
  "longitude": "30.31413",
  "typeId": 1,
  "shortDescription": "Свалка у подъезда",
  "detailedDescription": "Пакеты мусора лежат 3 дня",
  "address": "ул. Примерная, 1"
}
```
Успешный ответ (201): созданная запись `issues`.

- `DELETE /reports/:id` - удалить заявку (только `admin`).
- `PUT /reports/:id/status` - обновить статус (только `admin`).
```json
{ "statusId": 2 }
```

Коды ошибок: `401 Unauthorized` (нет сессии), `403 Forbidden` (нет прав), `404 Not Found`, `500 Internal Server Error`.